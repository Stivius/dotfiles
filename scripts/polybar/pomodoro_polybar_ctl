#!/bin/bash

check_param_str() {
	if [[ -z "$1" ]]; then
		exit
	fi
}

check_param_int() {
	case $1 in
		''|*[!0-9]*)
			exit
			;;
		*) # number
			;;
	esac
}

choose_task() {
	project_id=`pomodoro_cli.py --projects | rofi -dmenu -i | awk '{print $1}'`
	check_param_int "$project_id"
	selected_row=`{ echo "New task"; pomodoro_cli.py --tasks $project_id; } | rofi -dmenu -i`
	check_param_str "$selected_row"
	case "$selected_row" in
		"New task")
			task_name=`rofi -dmenu -theme-str 'listview { enabled: false;}'`
			check_param_str "$task_name"
			task_id=`pomodoro_cli.py --add-task $project_id "$task_name"`
			;;
		*)
			task_id=`echo $selected_row | awk '{print $1}'`
			;;
	esac
	check_param_int "$task_id"
	remove_current_pomo
	pomodoro_cli.py --start-pomo $task_id
	dunstify "Task started"
}

choose_rest() {
	task_id=`pomodoro_cli.py --rest | rofi -dmenu -i | awk '{print $1}'`
	check_param "$task_id"
	remove_current_pomo
	pomodoro_cli.py --start-pomo $task_id
	case $task_id in
		1)
			dunstify "Short Break started"
			REST_TIME=5
		;;
		2)
			dunstify "Long Break started"
			REST_TIME=15
		;;
	esac
}

remove_current_pomo() {
	result=`pomodoro_cli.py --remove-current-pomo`
	if [[ "$result" = "removed" ]]; then
		dunstify "Current task cancelled"
	fi
}

ACTION="$1"
PID="$2"
case $ACTION in

	"session" )
		choose_task
		pomodoro_polybar new 25 '祥' 'dunstify "Session finished"; pomodoro_cli.py --end-current-pomo; play -v 0.3 $HOME/scripts/bell.wav'; pomodoro_polybar update $PID
	;;

	"break" )
		choose_rest
		pomodoro_polybar new $REST_TIME '' 'dunstify "Break finished"; pomodoro_cli.py --end-current-pomo; play -v 0.3 $HOME/scripts/bell.wav' ; pomodoro_polybar update $PID
	;;

	"cancel" )
		remove_current_pomo
		pomodoro_polybar cancel ; pomodoro_polybar update $PID
	;;

	"increase" )
		#pomodoro_polybar increase 60 || pomodoro_polybar new 1 '祥' 'notify-send -u critical "Timer expired."' ; pomodoro_polybar update $PID
	;;

	"decrease" )
		#pomodoro_polybar increase -60 ; pomodoro_polybar update $PID
	;;

esac

